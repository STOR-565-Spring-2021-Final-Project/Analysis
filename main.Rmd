---
title: "Analysis of Shopping Data"
author: "Shilong Dai, Patrick Schmitt, Puyao Ge"
output: html_notebook
---
```{r, echo=T, results="hide"}
#libraries
library(MASS)
library(e1071)
library(caret)
library(rpart)
library(doMC) 
library(popbio)
library(ggplot2)
library(GGally)
library(ggridges)
library(smotefamily)
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
library(glmnet)
registerDoMC(cores = 11) 
```


```{r}
dat <- read.csv("./online_shoppers_intention.csv")
dat$OperatingSystems <- as.factor(dat$OperatingSystems)
dat$Browser <- as.factor(dat$Browser)
dat$Region <- as.factor(dat$Region)
dat$TrafficType <- as.factor(dat$TrafficType)
dat$Weekend <- as.factor(dat$Weekend)
dat$VisitorType <- as.factor(dat$VisitorType)


dat$OperatingSystems <- factor(dat$OperatingSystems, labels = make.names(levels(dat$OperatingSystems)))
dat$Browser <- factor(dat$Browser, labels = make.names(levels(dat$Browser)))
dat$Region <- factor(dat$Region, labels = make.names(levels(dat$Region)))
dat$TrafficType <- factor(dat$TrafficType, labels = make.names(levels(dat$TrafficType)))
dat$Weekend <- factor(dat$Weekend, labels = make.names(levels(dat$Weekend)))
dat$VisitorType <- factor(dat$VisitorType, labels = make.names(levels(dat$VisitorType)))


set.seed(100)
```

```{r}
for (i in c(1:10)) {
  hist(as.vector(dat[,i]), main=colnames(dat)[i])
}
```
```{r}
for (i in c(1:10)) {
  dat[,i] = log(dat[,i]+1)
}
for (i in c(1:10)) {
  hist(dat[,i], main=colnames(dat)[i])
}
```


```{r}
for (i in c(1:10)) {
  dat[,i] = as.vector(scale(dat[, i]))
}
for (i in c(1:10)) {
  hist(dat[,i], main=colnames(dat)[i])
}
```


```{r}
logi.hist.plot(dat$ExitRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Exitrate vs empirical probability of Revenue")
logi.hist.plot(dat$BounceRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Bouncerate vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated_Duration,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated_Duration vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated vs empirical probability of Revenue")
logi.hist.plot(dat$SpecialDay, dat$Revenue, boxp = FALSE, type="hist", col="gray")
title("SpecialDay vs empirical probability of Revenue")
logi.hist.plot(dat$PageValues,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Page Values vs empirical probability of Revenue")

mosaicplot(Region~Revenue, data=dat)
#region seems to be unimportant on its own
mosaicplot(VisitorType~Revenue, data=dat)
mosaicplot(TrafficType~Revenue, data=dat)
mosaicplot(Month~Revenue, data=dat)
```

#class priors
```{r}
print(paste("Prior probability of Revenue=TRUE: ", sum(dat$Revenue==TRUE)/nrow(dat)))
print(paste("Prior probability of Revenue=FALSE: ", sum(dat$Revenue==FALSE)/nrow(dat)))
```

```{r}
png(filename="bruteforce3.png", width=4096, height=4096)
ggpairs(
  data = dat,
  title = "Pairwise Plot",
  columns = colnames(dat)[1:10],
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
dev.off()

```


```{r}
true_dat <- dat[dat$Revenue == "TRUE", ]
monthTrafficTableT <- table(true_dat$Month, true_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()

false_dat <- dat[dat$Revenue == "FALSE", ]
monthTrafficTableF <- table(false_dat$Month, false_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionTrafficTableT <- table(true_dat$Region, true_dat$TrafficType)
regionTrafficTableF <- table(false_dat$Region, false_dat$TrafficType)

ggplot(data = as.data.frame(regionTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionMonthTableT <- table(true_dat$Region, true_dat$Month)
regionMonthTableF <- table(false_dat$Region, false_dat$Month)

ggplot(data = as.data.frame(regionMonthTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionMonthTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
visitorMonthTableT <- table(true_dat$VisitorType, true_dat$Month)
visitorMonthTableF <- table(false_dat$VisitorType, false_dat$Month)

ggplot(data = as.data.frame(regionMonthTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionMonthTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```


```{r}
ggplot(dat, aes(x = PageValues, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = PageValues, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = PageValues, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()

ggplot(dat, aes(x = BounceRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()

ggplot(dat, aes(x = ExitRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()

ggplot(dat, aes(x = ProductRelated, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()

ggplot(dat, aes(x = ProductRelated_Duration, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated_Duration, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated_Duration, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()

ggplot(dat, aes(x = SpecialDay, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = VisitorType, fill = Revenue)) +
  geom_density_ridges_gradient()
```

```{r}
dat_numerical <- dat[, -(11:18)]
dat_pcs <- prcomp(dat_numerical, scale = FALSE)
dat_pcs_sum <- summary(dat_pcs)
print(as.data.frame(dat_pcs_sum$importance[, 1:5]))
print(as.data.frame(dat_pcs$rotation))
```

```{r}
dat_pcs_df <- data.frame()
for(i in 1:10) {
  frame <- data.frame(PC = rep(paste0("PC", i), length(dat_pcs$x[, i])),
             Value = dat_pcs$x[, i])
  frame <- cbind(dat["Revenue"], frame)
  dat_pcs_df <- rbind(dat_pcs_df, frame)
}

# How to unfuck this
png(filename="bruteforce2.png", width=4096, height=4096)
ggplot(data = dat_pcs_df, aes(fill = Revenue)) + aes(x = Value) + geom_boxplot() +
  xlab("PC Value") + facet_grid(PC ~ .) + ggtitle("PC Score Distributions")
dev.off()
```

```{r}
pcs <- 10

dat_pcs_pair_df <- data.frame(dat_pcs$x[, 1:10])
dat_pcs_pair_df <- cbind(dat_pcs_pair_df, dat["Revenue"])

head(dat_pcs_pair_df)
png(filename="bruteforce.png", width=4096, height=4096)
ggpairs(
  data = dat_pcs_pair_df,
  title = "Pairwise PC Plot",
  columns = 1:10,
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
dev.off()
```

```{r}
k <- 2
k_cluster_2 <-
  kmeans(
    dat_pcs$x,
    centers = k,
    nstart = 25,
    iter.max = 1000
  )
# plots to compare
fviz_2 <-
  fviz_cluster(k_cluster_2, geom = "point", data = dat_pcs$x[, c(1, 5)]) + 
  ggtitle("KMeans Clusters 10 PCs")

print(fviz_2)
```

```{r}
# Summarize results of clustering.
dat_pcs_cluster_df <-
  cbind(dat[, c(18)], k_cluster_2$cluster)
dat_pcs_cluster_df <-as.data.frame(dat_pcs_cluster_df)
colnames(dat_pcs_cluster_df) <- c("Revenue", "Cluster")
dat_pcs_cluster_df[, 1] <- factor(dat_pcs_cluster_df[, 1])
dat_pcs_cluster_df[, 2] <- factor(dat_pcs_cluster_df[, 2])

cluster_bar_2 <-
  ggplot(data = dat_pcs_cluster_df, aes(fill = Revenue)) + aes(x = Cluster) + 
  geom_bar() + xlab("Cluster") + ylab("Count") + ggtitle("Clusters with 10 PCs")
print(cluster_bar_2)
```
```{r}
table(dat_pcs_cluster_df)
```


```{r}
train_size <- floor(0.75 * nrow(dat))
train_ind <- sample(seq_len(nrow(dat)), size = train_size)
train <- dat[train_ind, ]
test <- dat[-train_ind, ]

train$Revenue <- as.factor(train$Revenue)
train$Revenue <- factor(train$Revenue, labels = make.names(levels(train$Revenue)))

test$Revenue <- as.factor(test$Revenue)
test$Revenue <- factor(test$Revenue, labels = make.names(levels(test$Revenue)))

train_numerical <- train[, -(11:18)]
train_pcs <- prcomp(train_numerical, scale = FALSE)

adopted_train <- train[, 1:18]
adopted_train[, 1:10] <- train_pcs$x
colnames(adopted_train)[1:10] <- paste0("PC", 1:10)

head(adopted_train)
```

```{r}
png(filename="bruteforce4.png", width=4096, height=4096)
ggpairs(
  data = adopted_train,
  title = "Pairwise PC Plot",
  columns = 1:10,
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
dev.off()
```


```{r}
test_pcs <- predict(train_pcs, test)

adopted_test <- test[, 1:18]
adopted_test[, 1:10] <- test_pcs
colnames(adopted_test)[1:10] <- paste0("PC", 1:10)
head(adopted_test)
```

```{r}
# Dumy code categorical predictor variables
train_mat <- model.matrix(Revenue~., adopted_train)[,-1]
# Convert the outcome (class) to a numerical variable
revenue_vec <- ifelse(adopted_train$Revenue == "TRUE.", 1, 0)
```

```{r}
cv.lasso <- cv.glmnet(train_mat, revenue_vec, alpha = 1, family = "binomial")
plot(cv.lasso)
```
```{r}
coef(cv.lasso, cv.lasso$lambda.1se)
coef(cv.lasso, cv.lasso$lambda.min)
```


```{r}
train.control <- trainControl(method = "cv", number = 10)
train_pca <- adopted_train[, c(1:10, 18)]
test_pca <- adopted_test[, c(1:10, 18)]
```

```{r}
oversample <- nrow(train_pca[train_pca$Revenue == "FALSE.", ])/nrow(train_pca[train_pca$Revenue == "TRUE.", ])

train_pca_oversample <- SMOTE(train_pca[, 1:10], train_pca$Revenue, dup_size = oversample)$data
colnames(train_pca_oversample)[11] = "Revenue"
```



```{r}
tunegrid=data.frame(C=c(0.001, 0.01, 0.25, 0.5, 1, 5, 10))
# Train the model
model.cvsvm <- train(Revenue~., data = train_pca, method = "svmLinear",
               trControl = train.control, tuneGrid = tunegrid, metric = "Kappa")
# Summarize the results
print(model.cvsvm)
#SVM WIP
#model_svm = svm(Revenue~., data=train_pca, cost = 0.5, kernel = "linear")
#print(model_svm)

predict_svm <- predict(model.cvsvm, adopted_test)
cm.svm <-
  confusionMatrix(
    factor(predict_svm),
    factor(adopted_test$Revenue),
    dnn = c("Prediction", "Label"),
    positive="TRUE."
  )
cm.svm
cm.svm$byClass
```

```{r}
model.knn <- train(Revenue~., data = train_pca, method = "knn", trControl = train.control, metric = "Kappa")

print(model.knn)

predict_knn <- predict(model.knn, adopted_test)
cm.knn <-
  confusionMatrix(
    factor(predict_knn),
    factor(adopted_test$Revenue),
    dnn = c("Prediction", "Label"),
    positive="TRUE."
  )
cm.knn
cm.knn$byClass
```
```{r}
model.lda <- train(Revenue~., data = train_pca, method = "lda", trControl = train.control, metric = "Kappa")

print(model.lda)

predict_lda <- predict(model.lda, adopted_test)
cm.lda <-
  confusionMatrix(
    factor(predict_lda),
    factor(adopted_test$Revenue),
    dnn = c("Prediction", "Label"),
    positive="TRUE."
  )
cm.lda
cm.lda$byClass
```


```{r}
model.tree <- train(Revenue~., data = train_pca, method = "rpart", trControl = train.control, metric = "Kappa")

print(model.tree)

predict_tree <- predict(model.tree, adopted_test)
cm.tree <-
  confusionMatrix(
    factor(predict_tree),
    factor(adopted_test$Revenue),
    dnn = c("Prediction", "Label"),
    positive="TRUE."
  )
cm.tree
cm.tree$byClass
```


```{r}
model.qda <- qda(Revenue~., data = train_pca)
print(model.qda)

predict_qda <- predict(model.qda, adopted_test)
cm.qda <-
  confusionMatrix(
    factor(predict_tree),
    factor(adopted_test$Revenue),
    dnn = c("Prediction", "Label"),
    positive="TRUE."
  )
cm.qda
cm.qda$byClass
```

