---
title: "Analysis of Shopping Data"
author: "Shilong Dai, Patrick Schmitt, Puyao Ge"
output: html_notebook
---
```{r, echo=T, results="hide"}
#libraries
library(MASS)
library(e1071)
library(caret)
library(rpart)
library(doMC) 
library(popbio)
library(ggplot2)
library(GGally)
library(ggridges)
registerDoMC(cores = 11) 
```


```{r}
dat <- read.csv("./online_shoppers_intention.csv")
dat$OperatingSystems <- as.factor(dat$OperatingSystems)
dat$Browser <- as.factor(dat$Browser)
dat$Region <- as.factor(dat$Region)
dat$TrafficType <- as.factor(dat$TrafficType)
dat$Weekend <- as.factor(dat$Weekend)
set.seed(100)
train_size <- floor(0.75 * nrow(dat))
train_ind <- sample(seq_len(nrow(dat)), size = train_size)
train <- dat[train_ind, ]
test <- dat[-train_ind, ]

head(train)
```

```{r}
#visualization
logi.hist.plot(dat$ExitRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Exitrate vs empirical probability of Revenue")
logi.hist.plot(dat$BounceRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Bouncerate vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated_Duration,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated_Duration vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated vs empirical probability of Revenue")
logi.hist.plot(dat$SpecialDay, dat$Revenue, boxp = FALSE, type="hist", col="gray")
title("SpecialDay vs empirical probability of Revenue")
logi.hist.plot(dat$PageValues,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Page Values vs empirical probability of Revenue")

mosaicplot(Region~Revenue, data=dat)
#region seems to be unimportant on its own
mosaicplot(VisitorType~Revenue, data=dat)
mosaicplot(TrafficType~Revenue, data=dat)
mosaicplot(Month~Revenue, data=dat)
```

#class priors
```{r}
print(paste("Prior probability of Revenue=TRUE: ", sum(dat$Revenue==TRUE)/nrow(dat)))
print(paste("Prior probability of Revenue=FALSE: ", sum(dat$Revenue==FALSE)/nrow(dat)))
```

```{r}
ggpairs(
  data = dat,
  title = "Pairwise Plot",
  columns = c("BounceRates", "ExitRates", "PageValues"),
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
```

```{r}
true_dat <- dat[dat$Revenue == "TRUE", ]
monthTrafficTableT <- table(true_dat$Month, true_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()

false_dat <- dat[dat$Revenue == "FALSE", ]
monthTrafficTableF <- table(false_dat$Month, false_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionTrafficTableT <- table(true_dat$Region, true_dat$TrafficType)
regionTrafficTableF <- table(false_dat$Region, false_dat$TrafficType)

ggplot(data = as.data.frame(regionTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionMonthTableT <- table(true_dat$Region, true_dat$Month)
regionMonthTableF <- table(false_dat$Region, false_dat$Month)

ggplot(data = as.data.frame(regionMonthTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionMonthTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
ggplot(dat, aes(x = PageValues, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = PageValues, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
```

```{r}
dat_numerical <- dat[, -(11:18)]
dat_pcs <- prcomp(dat_numerical, scale = FALSE)
dat_pcs_sum <- summary(dat_pcs)
print(as.data.frame(dat_pcs_sum$importance[, 1:5]))
print(as.data.frame(dat_pcs$rotation))
```

```{r}
dat_pcs_df.1 <-
  data.frame(PC = rep("PC1", length(dat_pcs$x[, 1])),
             Value = dat_pcs$x[, 1])
dat_pcs_df.1 <-
  cbind(dat["Revenue"], dat_pcs_df.1)

dat_pcs_df.2 <-
  data.frame(PC = rep("PC2", length(dat_pcs$x[, 2])),
             Value = dat_pcs$x[, 2])
dat_pcs_df.2 <-
  cbind(dat["Revenue"], dat_pcs_df.2)

dat_pcs_df.3 <-
  data.frame(PC = rep("PC3", length(dat_pcs$x[, 3])),
             Value = dat_pcs$x[, 3])
dat_pcs_df.3 <-
  cbind(dat["Revenue"], dat_pcs_df.3)

dat_pcs_df <-
  rbind(dat_pcs_df.1, dat_pcs_df.2, dat_pcs_df.3)

# How to unfuck this
ggplot(data = dat_pcs_df, aes(fill = Revenue)) + aes(x = Value) + geom_density() +
  xlab("PC Value") + facet_grid(. ~ PC) + ggtitle("PC Score Distributions")
```

```{r}
dat_pcs_pair_df <- dat_pcs_df[dat_pcs_df$PC == "PC1", c(1, 3)]
colnames(dat_pcs_pair_df)[2] <- "PC1"
dat_pcs_pair_df <-
  cbind(dat_pcs_pair_df, dat_pcs_df[dat_pcs_df$PC == "PC2", c(3)])
colnames(dat_pcs_pair_df)[3] <- "PC2"
dat_pcs_pair_df <-
  cbind(dat_pcs_pair_df, dat_pcs_df[dat_pcs_df$PC == "PC3", c(3)])
colnames(dat_pcs_pair_df)[4] <- "PC3"
ggpairs(
  data = dat_pcs_pair_df,
  title = "Pairwise PC Plot",
  columns = 2:4,
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
```



```{r}
train.control <- trainControl(method = "cv", number = 10)
```


```{r}
tunegrid=data.frame(C=c(0.001, 0.01, 0.25, 0.5, 1, 5, 10))
# Train the model
model.cvsvm <- train(factor(Revenue) ~., data = train, method = "svmLinear",
               trControl = train.control, tuneGrid = tunegrid)
# Summarize the results
print(model.cvsvm)
```


```{r}
#SVM WIP
model_svm = svm(factor(Revenue) ~ ., data=train, cost = 0.25, kernel = "linear")
print(model_svm)

predictions_svm = predict(model_svm, test)
table(predictions_svm, test[["Revenue"]])
```