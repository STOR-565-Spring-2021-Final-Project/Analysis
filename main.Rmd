---
title: "Analysis of Shopping Data"
author: "Shilong Dai, Patrick Schmitt, Puyao Ge"
output: html_notebook
---
```{r, echo=T, results="hide"}
#libraries
library(MASS)
library(e1071)
library(caret)
library(rpart)
library(doMC) 
library(popbio)
library(ggplot2)
library(GGally)
library(ggridges)
registerDoMC(cores = 11) 
```


```{r}
dat <- read.csv("./online_shoppers_intention.csv")
dat$OperatingSystems <- as.factor(dat$OperatingSystems)
dat$Browser <- as.factor(dat$Browser)
dat$Region <- as.factor(dat$Region)
dat$TrafficType <- as.factor(dat$TrafficType)
dat$Weekend <- as.factor(dat$Weekend)


dat$OperatingSystems <- factor(dat$OperatingSystems, labels = make.names(levels(dat$OperatingSystems)))
dat$Browser <- factor(dat$Browser, labels = make.names(levels(dat$Browser)))
dat$Region <- factor(dat$Region, labels = make.names(levels(dat$Region)))
dat$TrafficType <- factor(dat$TrafficType, labels = make.names(levels(dat$TrafficType)))
dat$Weekend <- factor(dat$Weekend, labels = make.names(levels(dat$Weekend)))


set.seed(100)
```

```{r}
#visualization
logi.hist.plot(dat$ExitRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Exitrate vs empirical probability of Revenue")
logi.hist.plot(dat$BounceRates,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Bouncerate vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated_Duration,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated_Duration vs empirical probability of Revenue")
logi.hist.plot(dat$ProductRelated,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("ProductRelated vs empirical probability of Revenue")
logi.hist.plot(dat$SpecialDay, dat$Revenue, boxp = FALSE, type="hist", col="gray")
title("SpecialDay vs empirical probability of Revenue")
logi.hist.plot(dat$PageValues,dat$Revenue,boxp=FALSE,type="hist",col="gray")
title("Page Values vs empirical probability of Revenue")

mosaicplot(Region~Revenue, data=dat)
#region seems to be unimportant on its own
mosaicplot(VisitorType~Revenue, data=dat)
mosaicplot(TrafficType~Revenue, data=dat)
mosaicplot(Month~Revenue, data=dat)
```

#class priors
```{r}
print(paste("Prior probability of Revenue=TRUE: ", sum(dat$Revenue==TRUE)/nrow(dat)))
print(paste("Prior probability of Revenue=FALSE: ", sum(dat$Revenue==FALSE)/nrow(dat)))
```

```{r}
ggpairs(
  data = dat,
  title = "Pairwise Plot",
  columns = c("BounceRates", "ExitRates", "PageValues"),
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
```
```{r}
dat$ProductRelated_Duration <- log(dat$ProductRelated_Duration + 1)
dat$ProductRelated <- log(dat$ProductRelated + 1)
dat$PageValues <- log(dat$PageValues + 1)
```


```{r}
true_dat <- dat[dat$Revenue == "TRUE", ]
monthTrafficTableT <- table(true_dat$Month, true_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()

false_dat <- dat[dat$Revenue == "FALSE", ]
monthTrafficTableF <- table(false_dat$Month, false_dat$TrafficType)
ggplot(data = as.data.frame(monthTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionTrafficTableT <- table(true_dat$Region, true_dat$TrafficType)
regionTrafficTableF <- table(false_dat$Region, false_dat$TrafficType)

ggplot(data = as.data.frame(regionTrafficTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionTrafficTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
regionMonthTableT <- table(true_dat$Region, true_dat$Month)
regionMonthTableF <- table(false_dat$Region, false_dat$Month)

ggplot(data = as.data.frame(regionMonthTableT), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
ggplot(data = as.data.frame(regionMonthTableF), aes(x = Var1, y = Var2, fill = Freq)) + geom_tile()
```
```{r}
ggplot(dat, aes(x = PageValues, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = PageValues, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = BounceRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ExitRates, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = ProductRelated, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = TrafficType, fill = Revenue)) +
  geom_density_ridges_gradient()
ggplot(dat, aes(x = SpecialDay, y = Month, fill = Revenue)) +
  geom_density_ridges_gradient()
```

```{r}
dat_numerical <- dat[, -(11:18)]
dat_pcs <- prcomp(dat_numerical, scale = FALSE)
dat_pcs_sum <- summary(dat_pcs)
print(as.data.frame(dat_pcs_sum$importance[, 1:5]))
print(as.data.frame(dat_pcs$rotation))
```

```{r}
dat_pcs_df.1 <-
  data.frame(PC = rep("PC4", length(dat_pcs$x[, 4])),
             Value = dat_pcs$x[, 4])
dat_pcs_df.1 <-
  cbind(dat["Revenue"], dat_pcs_df.1)

dat_pcs_df.2 <-
  data.frame(PC = rep("PC5", length(dat_pcs$x[, 5])),
             Value = dat_pcs$x[, 5])
dat_pcs_df.2 <-
  cbind(dat["Revenue"], dat_pcs_df.2)

dat_pcs_df.3 <-
  data.frame(PC = rep("PC6", length(dat_pcs$x[, 6])),
             Value = dat_pcs$x[, 6])
dat_pcs_df.3 <-
  cbind(dat["Revenue"], dat_pcs_df.3)

dat_pcs_df <-
  rbind(dat_pcs_df.1, dat_pcs_df.2, dat_pcs_df.3)

# How to unfuck this
ggplot(data = dat_pcs_df, aes(fill = Revenue)) + aes(x = Value) + geom_density() +
  xlab("PC Value") + facet_grid(. ~ PC) + ggtitle("PC Score Distributions")
```

```{r}
pcs <- 10

dat_pcs_pair_df <- data.frame(dat_pcs$x[, 1:10])
dat_pcs_pair_df <- cbind(dat_pcs_pair_df, dat["Revenue"])

head(dat_pcs_pair_df)
png(filename="bruteforce.png", width=4096, height=4096)
ggpairs(
  data = dat_pcs_pair_df,
  title = "Pairwise PC Plot",
  columns = 1:10,
  upper = list(continuous = "points"),
  mapping = ggplot2::aes(color = Revenue),
  legend = 1
)
dev.off()
```

```{r}
train_size <- floor(0.75 * nrow(dat))
train_ind <- sample(seq_len(nrow(dat)), size = train_size)
train <- dat[train_ind, ]
test <- dat[-train_ind, ]

train$Revenue <- as.factor(train$Revenue)
train$Revenue <- factor(train$Revenue, labels = make.names(levels(train$Revenue)))

test$Revenue <- as.factor(test$Revenue)
test$Revenue <- factor(test$Revenue, labels = make.names(levels(test$Revenue)))

train_numerical <- train[, -(11:18)]
train_pcs <- prcomp(train_numerical, scale = FALSE)

adopted_train <- train[, -(3:10)]
adopted_train$Administrative <- train_pcs$x[, 1]
adopted_train$Administrative_Duration <- train_pcs$x[, 2]
colnames(adopted_test)[1] <- "PC1"
colnames(adopted_test)[2] <- "PC2"

head(adopted_train)
```

```{r}
test_pcs <- predict(train_pcs, test)

adopted_test <- test[, -(3:10)]
adopted_test$Administrative <- test_pcs[, 1]
adopted_test$Administrative_Duration <- test_pcs[, 2]
colnames(adopted_test)[1] <- "PC1"
colnames(adopted_test)[2] <- "PC2"
head(adopted_test)
```



```{r}
train.control <- trainControl(method = "cv", number = 10)

```


```{r}
tunegrid=data.frame(C=c(0.001, 0.01, 0.25, 0.5, 1, 5, 10))
# Train the model
model.cvsvm <- train(Revenue~., data = train, method = "svmLinear",
               trControl = train.control, tuneGrid = tunegrid, metric = "Kappa")
# Summarize the results
print(model.cvsvm)
```

```{r}
model.glm <- train(Revenue~., data = train, method = "glm", trControl = train.control, metric = "Kappa")
print(model.glm)
```


```{r}
#SVM WIP
model_svm = svm(factor(Revenue) ~ ., data=train, cost = 0.25, kernel = "linear")
print(model_svm)

predictions_svm = predict(model_svm, test)
table(predictions_svm, test[["Revenue"]])
```